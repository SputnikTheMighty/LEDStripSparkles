#include "LPF.h"

static int filter_taps[LPF_TAP_NUM] = {
  -470,
  -86,
  -94,
  -102,
  -110,
  -118,
  -127,
  -136,
  -144,
  -154,
  -163,
  -172,
  -181,
  -191,
  -200,
  -209,
  -219,
  -228,
  -237,
  -246,
  -255,
  -263,
  -272,
  -280,
  -288,
  -295,
  -302,
  -309,
  -315,
  -321,
  -326,
  -331,
  -335,
  -338,
  -341,
  -344,
  -345,
  -346,
  -346,
  -346,
  -345,
  -343,
  -340,
  -336,
  -332,
  -327,
  -321,
  -314,
  -306,
  -298,
  -289,
  -279,
  -268,
  -257,
  -245,
  -232,
  -219,
  -205,
  -190,
  -175,
  -159,
  -143,
  -126,
  -109,
  -92,
  -75,
  -57,
  -39,
  -20,
  -2,
  16,
  35,
  53,
  71,
  89,
  106,
  123,
  140,
  156,
  172,
  187,
  202,
  216,
  229,
  242,
  253,
  264,
  274,
  283,
  290,
  297,
  303,
  307,
  311,
  313,
  314,
  314,
  312,
  310,
  306,
  301,
  295,
  288,
  279,
  269,
  258,
  246,
  233,
  219,
  204,
  188,
  171,
  153,
  134,
  115,
  95,
  74,
  53,
  31,
  9,
  -14,
  -37,
  -59,
  -83,
  -106,
  -129,
  -152,
  -175,
  -197,
  -219,
  -241,
  -262,
  -282,
  -302,
  -321,
  -339,
  -356,
  -373,
  -388,
  -402,
  -415,
  -427,
  -437,
  -447,
  -454,
  -461,
  -466,
  -470,
  -472,
  -472,
  -472,
  -469,
  -466,
  -460,
  -453,
  -445,
  -435,
  -424,
  -412,
  -398,
  -383,
  -366,
  -349,
  -330,
  -310,
  -289,
  -267,
  -244,
  -220,
  -195,
  -170,
  -144,
  -118,
  -91,
  -64,
  -37,
  -9,
  19,
  47,
  74,
  102,
  129,
  156,
  182,
  208,
  234,
  258,
  282,
  305,
  328,
  349,
  369,
  389,
  407,
  424,
  439,
  454,
  467,
  479,
  489,
  499,
  506,
  513,
  518,
  522,
  524,
  525,
  525,
  523,
  520,
  516,
  510,
  504,
  496,
  487,
  477,
  467,
  455,
  443,
  430,
  416,
  401,
  386,
  371,
  355,
  339,
  323,
  307,
  290,
  274,
  258,
  242,
  226,
  211,
  196,
  182,
  168,
  155,
  142,
  131,
  120,
  110,
  101,
  93,
  85,
  79,
  74,
  71,
  68,
  66,
  65,
  66,
  68,
  71,
  74,
  79,
  85,
  93,
  101,
  110,
  120,
  131,
  142,
  155,
  168,
  182,
  196,
  211,
  226,
  242,
  258,
  274,
  290,
  307,
  323,
  339,
  355,
  371,
  386,
  401,
  416,
  430,
  443,
  455,
  467,
  477,
  487,
  496,
  504,
  510,
  516,
  520,
  523,
  525,
  525,
  524,
  522,
  518,
  513,
  506,
  499,
  489,
  479,
  467,
  454,
  439,
  424,
  407,
  389,
  369,
  349,
  328,
  305,
  282,
  258,
  234,
  208,
  182,
  156,
  129,
  102,
  74,
  47,
  19,
  -9,
  -37,
  -64,
  -91,
  -118,
  -144,
  -170,
  -195,
  -220,
  -244,
  -267,
  -289,
  -310,
  -330,
  -349,
  -366,
  -383,
  -398,
  -412,
  -424,
  -435,
  -445,
  -453,
  -460,
  -466,
  -469,
  -472,
  -472,
  -472,
  -470,
  -466,
  -461,
  -454,
  -447,
  -437,
  -427,
  -415,
  -402,
  -388,
  -373,
  -356,
  -339,
  -321,
  -302,
  -282,
  -262,
  -241,
  -219,
  -197,
  -175,
  -152,
  -129,
  -106,
  -83,
  -59,
  -37,
  -14,
  9,
  31,
  53,
  74,
  95,
  115,
  134,
  153,
  171,
  188,
  204,
  219,
  233,
  246,
  258,
  269,
  279,
  288,
  295,
  301,
  306,
  310,
  312,
  314,
  314,
  313,
  311,
  307,
  303,
  297,
  290,
  283,
  274,
  264,
  253,
  242,
  229,
  216,
  202,
  187,
  172,
  156,
  140,
  123,
  106,
  89,
  71,
  53,
  35,
  16,
  -2,
  -20,
  -39,
  -57,
  -75,
  -92,
  -109,
  -126,
  -143,
  -159,
  -175,
  -190,
  -205,
  -219,
  -232,
  -245,
  -257,
  -268,
  -279,
  -289,
  -298,
  -306,
  -314,
  -321,
  -327,
  -332,
  -336,
  -340,
  -343,
  -345,
  -346,
  -346,
  -346,
  -345,
  -344,
  -341,
  -338,
  -335,
  -331,
  -326,
  -321,
  -315,
  -309,
  -302,
  -295,
  -288,
  -280,
  -272,
  -263,
  -255,
  -246,
  -237,
  -228,
  -219,
  -209,
  -200,
  -191,
  -181,
  -172,
  -163,
  -154,
  -144,
  -136,
  -127,
  -118,
  -110,
  -102,
  -94,
  -86,
  -470
};

void LPF_init(LPF_T* f) {
  int i;
  for(i = 0; i < LPF_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void LPF_put(LPF_T* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == LPF_TAP_NUM)
    f->last_index = 0;
}

int LPF_get(LPF_T* f) {
  long long acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < LPF_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : LPF_TAP_NUM-1;
    acc += (long long)f->history[index] * filter_taps[i];
  };
  return acc >> 16;
}
